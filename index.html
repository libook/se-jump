<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>星球附近的最近跃迁点</title>
    <script>
        const GPS_REGEXP = /^GPS:[^:]*(:[0-9-.]+){3}:$/;
        const PLANET_RADIUS = 120 * 1000 / 2; // Default radius of planets.
        const MOON_RADIUS = 19 * 1000 / 2; // Default radius of moons.
        const GRAVITY_RANGE_COEFFICIENT = 1 + 0.7182;
        const SAFE_DISTANCE = 1 * 1000; // 1km

        const findPoint = (Xs, Ys, Zs, Xp, Yp, Zp, type) => {
            const radius = (() => {
                if (type === 'Planet') {
                    return PLANET_RADIUS;
                } else if (type === 'Moon') {
                    return MOON_RADIUS;
                }
            })();

            const gravityRadius = radius * GRAVITY_RANGE_COEFFICIENT + SAFE_DISTANCE;

            const distanceFromShipToPlanet = ((Xs - Xp) ** 2 + (Ys - Yp) ** 2 + (Zs - Zp) ** 2) ** 0.5;
            console.log(distanceFromShipToPlanet);

            const T = gravityRadius / distanceFromShipToPlanet;
            console.log(T);

            const
                Xt = Xp + (Xs - Xp) * T,
                Yt = Yp + (Ys - Yp) * T,
                Zt = Zp + (Zs - Zp) * T;

            return { Xt, Yt, Zt };
        };

        const gpsParser = (gpsString) => {
            if (GPS_REGEXP.test(gpsString)) {
                const [, name, x, y, z] = gpsString.split(':');
                return {
                    name,
                    "x": parseFloat(x),
                    "y": parseFloat(y),
                    "z": parseFloat(z),
                };
            } else {
                return undefined;
            }
        };
        const gpsToString = (gpsObject) => {
            return `GPS:${gpsObject.name}:${gpsObject.x}:${gpsObject.y}:${gpsObject.z}:`;
        };

        window.change = () => {
            const targetGps = document.getElementById('targetGps');
            targetGps.value = '';

            const
                shipGps = document.getElementById('shipGps').value,
                planetGps = document.getElementById('planetGps').value;
            const
                shipGpsObj = gpsParser(shipGps),
                planetGpsObj = gpsParser(planetGps);

            const radioElementList = document.getElementsByName('type');
            const type = (() => {
                for (const radioElement of radioElementList) {
                    if (radioElement.checked) {
                        return radioElement.value;
                    }
                }
            })();

            if (
                shipGpsObj !== undefined
                && planetGpsObj !== undefined
                && (
                    shipGpsObj.x !== planetGpsObj.x
                    || shipGpsObj.y !== planetGpsObj.y
                    || shipGpsObj.z !== planetGpsObj.z
                )
            ) {
                const { Xt, Yt, Zt } = findPoint(
                    shipGpsObj.x,
                    shipGpsObj.y,
                    shipGpsObj.z,
                    planetGpsObj.x,
                    planetGpsObj.y,
                    planetGpsObj.z,
                    type,
                );
                targetGps.value = gpsToString({
                    "name": `${planetGpsObj.name}-jump`,
                    "x": Xt,
                    "y": Yt,
                    "z": Zt,
                });
            }
        };
    </script>
    <style>
        input[ type="text"] {
            width: 500px;
        }
    </style>
</head>

<body>
<div>
    <p>
        太空工程师游戏中的跃迁引擎不能将有自然重力的GPS坐标设置为跃迁目的地，如果希望先跃迁到行星引力圈外再降落的话，可以使用这个工具生成一个飞船到行星引力圈外的最近跃迁目的地GPS坐标。</p>
    <p>
        用法：选择目的地是行星还是卫星，然后将当前飞船的GPS坐标填入“飞船GPS”框，将行星中心GPS坐标填入“行星GPS”框，跃迁最近GPS坐标会自动显示在“跃迁最近GPS”框中，可以直接复制并粘贴到游戏内。如果使用的是默认的“星系”地图的话，可以直接点击星球的按钮，以便于自动填写预设星球类型以及行星GPS。</p>
    <p>暂未经过测试。</p>
</div>
<div>
    <div>
        <label><input type="radio" name="type" onchange="change()"
                      value="Planet">行星</label>
        <label><input type="radio" name="type" onchange="change()" value="Moon">卫星</label>
    </div>
    <div><label>飞船GPS：<input type="text" id="shipGps"
                             onchange="change()"></label></div>
    <div><label>行星GPS：<input type="text" id="planetGps"
                             onchange="change()"></label></div>
    <div>
        <button onclick="document.querySelector('input[value=Planet]').checked=true;document.getElementById('planetGps').value='GPS:Earth:0:0:0:';change();">
            地球
        </button>
        <button onclick="document.querySelector('input[value=Moon]').checked=true;document.getElementById('planetGps').value='GPS:Moon:16384:136384:-113616:';change();">
            月球
        </button>
        <button onclick="document.querySelector('input[value=Planet]').checked=true;document.getElementById('planetGps').value='GPS:Mars:1031072:131072:1631072:';change();">
            火星
        </button>
        <button onclick="document.querySelector('input[value=Moon]').checked=true;document.getElementById('planetGps').value='GPS:Europa:916384:16384:1616384:';change();">
            欧罗巴
        </button>
        <button onclick="document.querySelector('input[value=Planet]').checked=true;document.getElementById('planetGps').value='GPS:Alien:131072:131072:5731072:';change();">
            异星
        </button>
        <button onclick="document.querySelector('input[value=Moon]').checked=true;document.getElementById('planetGps').value='GPS:Titan:36384:226384:5796384:';change();">
            泰坦
        </button>
    </div>
    <div><label>跃迁最近GPS：<input type="text" readonly id="targetGps"></label>
    </div>
</div>
</body>

</html>
